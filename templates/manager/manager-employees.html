<!DOCTYPE html>
<html lang="en">
<head>
  {% include "partials/head.html" with page_title="ShiftSync - Employee Management" page_description="ShiftSync - Manage employees" %}
	</head>
	<body>
	  {% include "partials/toast_messages.html" %}

	  {% include "partials/header.html" with nav_active="manager_employees" %}

  <main class="main-content main-content-tight-top">
    <!-- Top controls -->
    <div class="card page-toolbar-card">
      <div class="filters-row" style="align-items: flex-end; justify-content: space-between; flex-wrap: nowrap;">
        <div class="filters-row" style="align-items: flex-end; flex-wrap: nowrap;">
        <div class="filter-group" style="flex: 1 1 840px; max-width: 840px; min-width: 360px;">
          <label class="form-label" for="employeeSearch">Search:</label>
          <input class="form-input" id="employeeSearch" placeholder="Search by name, email, phone, or ID" oninput="applyEmployeeFilters()" value="{{ q|default:'' }}">
        </div>

        <div class="filter-group">
          <label class="form-label" for="roleFilter">Role:</label>
          <select class="hidden" id="roleFilter" onchange="applyEmployeeFilters()" aria-hidden="true" tabindex="-1">
            <option value="all" {% if not position %}selected{% endif %}>All</option>
            {% for p in positions %}
              <option value="{{ p.id }}" {% if position == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
          <div class="multiselect" id="roleFilterMulti">
            <button class="btn btn-outline btn-sm multiselect-trigger" type="button" onclick="toggleMulti('roleFilterMulti')" aria-haspopup="true" aria-expanded="false">
              <span id="roleFilterMultiLabel">All</span>
              {% include "partials/icons/chevron_down.html" with size=16 %}
            </button>
            <div class="multiselect-menu" role="menu" aria-label="Role">
              <label class="multiselect-item"><input type="radio" name="employeeRoleChoice" value="all" {% if not position %}checked{% endif %} onchange="setEmployeeRoleFilter(this.value)"> All</label>
              {% for p in positions %}
                <label class="multiselect-item"><input type="radio" name="employeeRoleChoice" value="{{ p.id }}" {% if position == p.id|stringformat:'s' %}checked{% endif %} onchange="setEmployeeRoleFilter(this.value)"> {{ p.name }}</label>
              {% endfor %}
            </div>
          </div>
        </div>
        </div>

        <div class="filters-row" style="align-items: flex-end; justify-content: flex-end; flex-wrap: nowrap;">
          <button class="btn btn-primary" type="button" onclick="openModal('addEmployeeModal')">
            {% include "partials/icons/plus.html" with size=16 %}
            Add employee
          </button>
          <button class="btn btn-outline" type="button" onclick="openModal('rolesModal')">Manage roles</button>
        </div>
      </div>
    </div>

    <!-- Employee Table -->
    <div class="card mt-4">
      <div class="table-container">
        <table class="table table-fixed" aria-label="Employee list">
          <colgroup>
            <col style="width: 72px;">
            <col style="width: 130px;">
            <col style="width: 220px;">
            <col style="width: 160px;">
            <col style="width: 240px;">
            <col style="width: 160px;">
            <col style="width: 80px;">
          </colgroup>
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Employee ID</th>
              <th>Full name</th>
              <th>Role</th>
              <th>Email</th>
              <th>Phone</th>
              <th style="width: 80px;">Actions</th>
            </tr>
          </thead>
          <tbody id="employeeTbody">
            {% for e in employees %}
              <tr class="employee-row" data-role="{{ e.position_id|default:'' }}" data-user-id="{{ e.id }}">
                <td>
                  {% with fi=e.first_name|slice:":1" li=e.last_name|slice:":1" %}
                    <div class="header-avatar" style="width: 2rem; height: 2rem;">
                      {% if fi or li %}
                        {{ fi }}{{ li }}
                      {% else %}
                        {{ e.username|slice:":2"|upper }}
                      {% endif %}
                    </div>
                  {% endwith %}
                </td>
                <td class="text-sm">{{ e.employee_id }}</td>
                <td class="font-medium">{{ e.get_full_name|default:e.username }}</td>
                <td>
                  {% if e.position %}
                    <span class="badge badge-default">{{ e.position.name }}</span>
                  {% else %}
                    <span class="text-sm text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-sm">{{ e.email }}</td>
                <td class="text-sm">{{ e.phone|default:"—" }}</td>
                <td class="table-actions-cell">
                  <div class="dropdown dropdown-fixed">
                    <button class="btn btn-ghost btn-icon" type="button" onclick="toggleDropdown(this)" aria-label="Row actions">
                      {% include "partials/icons/more_vertical.html" with size=18 %}
                    </button>
                    <div class="dropdown-menu">
                      <button class="dropdown-item" type="button" onclick="openEditEmployee({{ e.id }})">View/Edit</button>
                      <button class="dropdown-item" type="button" onclick="openResetPassword('{{ e.employee_id }}','{{ e.email }}','{% url 'reset_employee_password' e.id %}')">Reset password</button>
                      <div class="dropdown-divider"></div>
                      <button class="dropdown-item dropdown-item-destructive" type="button" onclick="openDeleteEmployee({{ e.id }}, '{{ e.employee_id }}', '{{ e.email }}')">Delete</button>
                    </div>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7">
                  <div class="empty-state" style="padding: 2rem;">
                    <div class="empty-state-title">No employees yet</div>
                    <div class="empty-state-description">Add your first employee to start assigning shifts.</div>
                    <button class="btn btn-primary" type="button" onclick="openModal('addEmployeeModal')">+ Add employee</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Add Employee Modal -->
  <div class="modal-overlay hidden" id="addEmployeeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add New Employee</h2>
        <button class="modal-close" onclick="closeModal('addEmployeeModal')" aria-label="Close">
          {% include "partials/icons/x.html" %}
        </button>
      </div>
      <form method="post" action="{% url 'manager_employees' %}" id="addEmployeeForm" novalidate>
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="addFullName">Full name *</label>
            <input type="text" class="form-input" id="addFullName" name="full_name" placeholder="Enter full name" required>
            <div class="form-error-message hidden" id="addFullNameError"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="addEmail">Email / Login *</label>
            <input type="email" class="form-input" id="addEmail" name="email" placeholder="Enter email" required>
            <div class="form-error-message hidden" id="addEmailError"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="addPhone">Phone *</label>
            <input type="tel" class="form-input" id="addPhone" name="phone" placeholder="+1 (555) 123-4567" required>
            <div class="form-error-message hidden" id="addPhoneError"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="addRole">Role *</label>
            <select class="form-select" id="addRole" name="position" required>
              <option value="">Select role...</option>
              {% include "partials/options/positions.html" %}
            </select>
            <div class="form-error-message hidden" id="addRoleError"></div>
          </div>

          <p class="text-sm text-muted">
            Security: A temporary password is generated automatically and shown <strong>only once</strong> after creation.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" type="button" onclick="closeModal('addEmployeeModal')">Cancel</button>
          <button class="btn btn-primary" type="submit">Create employee</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Employee Modal -->
  <div class="modal-overlay hidden" id="editEmployeeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">View/Edit Employee</h2>
        <button class="modal-close" onclick="closeModal('editEmployeeModal')" aria-label="Close">
          {% include "partials/icons/x.html" %}
        </button>
      </div>
      <form id="editEmployeeForm" class="modal-body" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" id="editUserId" value="">
        <div class="form-group">
          <label class="form-label" for="editFullName">Full name *</label>
          <input type="text" class="form-input" id="editFullName" value="" required>
          <div class="form-error-message hidden" id="editFullNameError"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editEmail">Email / Login *</label>
          <input type="email" class="form-input" id="editEmail" value="" required>
          <div class="form-error-message hidden" id="editEmailError"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editPhone">Phone *</label>
          <input type="tel" class="form-input" id="editPhone" value="" required>
          <div class="form-error-message hidden" id="editPhoneError"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editRole">Role *</label>
          <select class="form-select" id="editRole" required>
            <option value="">Select role...</option>
            {% include "partials/options/positions.html" %}
          </select>
          <div class="form-error-message hidden" id="editRoleError"></div>
        </div>

      </form>
      <div class="modal-footer">
        <button class="btn btn-primary" type="button" onclick="saveEmployeeEdits()">Save</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  {% include "partials/confirm_modal.html" with modal_id="resetPasswordModal" title="Reset password" message="Are you sure you want to reset the password for:" message_detail_id="resetEmployeeLabel" confirm_text="Yes" cancel_text="No" cancel_action="cancelResetPassword()" confirm_action="confirmResetPassword()" %}

  <!-- Delete Employee Confirm Modal -->
  {% include "partials/confirm_modal.html" with modal_id="deleteEmployeeModal" title="Delete employee" message="Are you sure you want to delete this employee?" message_detail_id="deleteEmployeeLabel" message_footer="This will remove the employee and their assignments." confirm_text="Yes, delete" cancel_text="No" cancel_action="cancelDeleteEmployee()" confirm_action="confirmDeleteEmployee()" destructive=True modal_size="520px" %}

  <!-- One-time Credentials Modal -->
  {% if creds %}
    <div class="modal-overlay" id="credentialsModal" data-autoshow="1">
      <div class="modal" style="max-width: 560px;">
        <div class="modal-header">
          <h2 class="modal-title">Credentials (shown once)</h2>
          <button class="modal-close" onclick="closeModal('credentialsModal')" aria-label="Close">
            {% include "partials/icons/x.html" %}
          </button>
        </div>
        <div class="modal-body">
          <div class="preview-box">
            <div class="text-sm text-muted">Login</div>
            <div class="flex items-center justify-between mt-1">
              <div class="font-medium" id="credLogin">{{ creds.login }}</div>
              <button class="btn btn-ghost btn-sm" type="button" onclick="copyText('credLogin')">Copy</button>
            </div>

            <div class="text-sm text-muted mt-3">Temporary password</div>
            <div class="flex items-center justify-between mt-1">
              <div class="font-medium" id="credPassword">{{ creds.temporary_password }}</div>
              <button class="btn btn-ghost btn-sm" type="button" onclick="copyText('credPassword')">Copy</button>
            </div>
          </div>

          <p class="text-sm text-muted mt-3">
            This password is shown only once. Copy and share it securely.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="button" onclick="closeModal('credentialsModal')">Done</button>
        </div>
      </div>
    </div>
  {% endif %}

	  <!-- Manage Roles Modal -->
	  <div class="modal-overlay hidden" id="rolesModal">
	    <div class="modal" style="max-width: 720px;">
      <div class="modal-header">
        <h2 class="modal-title">Manage roles</h2>
        <button class="modal-close" onclick="closeModal('rolesModal')" aria-label="Close">
          {% include "partials/icons/x.html" %}
        </button>
      </div>
      <div class="modal-body">
        <div class="card mt-4" style="padding: 1rem;">
          <div class="flex gap-2">
            <input class="form-input" id="newRoleName" placeholder="New role name (e.g., Barista)">
            <button class="btn btn-primary btn-sm" onclick="addRole()">Add role</button>
          </div>
        </div>

        <div class="table-container mt-4">
          <table class="table" aria-label="Role list">
            <thead>
              <tr>
                <th>Role</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
	            <tbody id="roleTbody">
		              {% for p in positions %}
		                <tr data-position-id="{{ p.id }}">
		                  <td class="role-name">{{ p.name }}</td>
		                  <td class="role-actions-cell">
		                    <button class="btn btn-outline btn-sm" type="button" onclick="renameRole(this)">Rename</button>
		                    <button class="btn btn-ghost btn-icon" type="button" onclick="deleteRole(this)" aria-label="Delete role" title="Delete" style="color: var(--destructive);">
		                      {% include "partials/icons/trash.html" with size=18 %}
		                    </button>
		                  </td>
		                </tr>
		              {% empty %}
		                <tr><td colspan="2" class="text-sm text-muted">No roles yet.</td></tr>
		              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('rolesModal')">Done</button>
      </div>
	    </div>
	  </div>

  <!-- Delete Role Confirm Modal -->
  {% include "partials/confirm_modal.html" with modal_id="deleteRoleModal" title="Delete role" message="Are you really want to delete this role:" message_detail_id="deleteRoleName" confirm_text="Yes, delete" cancel_text="No" cancel_action="cancelDeleteRole()" confirm_action="confirmDeleteRole()" destructive=True modal_size="520px" %}

	  <div
	    id="managerEmployeesPage"
	    data-position-create-url="{% url 'position_create' %}"
	    data-position-update-url-template="{% url 'position_update' 0 %}"
    data-position-delete-url-template="{% url 'position_delete' 0 %}"
    data-employee-details-url-template="{% url 'employee_details' 0 %}"
    data-employee-update-url-template="{% url 'employee_update' 0 %}"
    data-employee-reset-password-url-template="{% url 'reset_employee_password' 0 %}"
    data-employee-delete-url-template="{% url 'employee_delete' 0 %}"
  ></div>
  <form id="resetPasswordForm" method="post">
    {% csrf_token %}
  </form>
  <form id="deleteEmployeeForm" method="post">
    {% csrf_token %}
  </form>
  {% include "partials/scripts.html" with page_script="js/manager-employees.js" %}
</body>
</html>
