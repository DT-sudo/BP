{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShiftSync - Employee Management</title>
  <meta name="description" content="ShiftSync - Manage employees">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}?v={% now 'U' %}">
</head>
<body>
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>
  {% if messages %}
    <ul id="djangoMessages" class="hidden">
      {% for message in messages %}
        <li data-level="{{ message.tags }}" data-text="{{ message|escape }}"></li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Header -->
  <header class="header">
    <div class="header-brand">
      <div class="header-logo" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
          <line x1="16" x2="16" y1="2" y2="6"/>
          <line x1="8" x2="8" y1="2" y2="6"/>
          <line x1="3" x2="21" y1="10" y2="10"/>
        </svg>
      </div>
      <span class="header-title">ShiftSync</span>
    </div>

    <nav class="header-nav" aria-label="Primary">
      <a href="{% if request.session.manager_shifts_last_url %}{{ request.session.manager_shifts_last_url }}{% else %}{% url 'manager_shifts' %}{% endif %}" class="nav-link">Shifts</a>
      <a href="{% url 'manager_employees' %}" class="nav-link active">Team</a>
    </nav>

    <div class="dropdown header-user">
      <button class="btn btn-ghost btn-sm header-user-trigger" type="button" onclick="toggleUserMenu(this)" aria-label="User menu">
        <div class="header-avatar" aria-label="User avatar">{{ user_initials|default:"M" }}</div>
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-item dropdown-item-static dropdown-item-title">{{ user_display_name|default:"Manager" }}</div>
        <div class="dropdown-item dropdown-item-static">{{ user_header_role|default:"Manager" }}</div>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item dropdown-item-destructive" href="{% url 'logout' %}">Logout</a>
      </div>
    </div>
  </header>

  <main class="main-content main-content-tight-top">
    <!-- Top controls -->
    <div class="card page-toolbar-card">
      <div class="filters-row" style="align-items: flex-end; justify-content: space-between; flex-wrap: nowrap;">
        <div class="filters-row" style="align-items: flex-end; flex-wrap: nowrap;">
        <div class="filter-group" style="flex: 1 1 840px; max-width: 840px; min-width: 360px;">
          <label class="form-label" for="employeeSearch">Search:</label>
          <input class="form-input" id="employeeSearch" placeholder="Search by name, email, phone, or ID" oninput="applyEmployeeFilters()" value="{{ q|default:'' }}">
        </div>

        <div class="filter-group">
          <label class="form-label" for="roleFilter">Role:</label>
          <select class="hidden" id="roleFilter" onchange="applyEmployeeFilters()" aria-hidden="true" tabindex="-1">
            <option value="all" {% if not position %}selected{% endif %}>All</option>
            {% for p in positions %}
              <option value="{{ p.id }}" {% if position == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
          <div class="multiselect" id="roleFilterMulti">
            <button class="btn btn-outline btn-sm multiselect-trigger" type="button" onclick="toggleMulti('roleFilterMulti')" aria-haspopup="true" aria-expanded="false">
              <span id="roleFilterMultiLabel">All</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="m6 9 6 6 6-6"/>
              </svg>
            </button>
            <div class="multiselect-menu" role="menu" aria-label="Role">
              <label class="multiselect-item"><input type="radio" name="employeeRoleChoice" value="all" {% if not position %}checked{% endif %} onchange="setEmployeeRoleFilter(this.value)"> All</label>
              {% for p in positions %}
                <label class="multiselect-item"><input type="radio" name="employeeRoleChoice" value="{{ p.id }}" {% if position == p.id|stringformat:'s' %}checked{% endif %} onchange="setEmployeeRoleFilter(this.value)"> {{ p.name }}</label>
              {% endfor %}
            </div>
          </div>
        </div>
        </div>

        <div class="filters-row" style="align-items: flex-end; justify-content: flex-end; flex-wrap: nowrap;">
          <button class="btn btn-primary" type="button" onclick="openModal('addEmployeeModal')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 5v14"/>
              <path d="M5 12h14"/>
            </svg>
            Add employee
          </button>
          <button class="btn btn-outline" type="button" onclick="openModal('rolesModal')">Manage roles</button>
        </div>
      </div>
    </div>

    <!-- Employee Table -->
    <div class="card" style="margin-top: 1rem;">
      <div class="table-container">
        <table class="table table-fixed" aria-label="Employee list">
          <colgroup>
            <col style="width: 72px;">
            <col style="width: 130px;">
            <col style="width: 220px;">
            <col style="width: 160px;">
            <col style="width: 240px;">
            <col style="width: 160px;">
            <col style="width: 80px;">
          </colgroup>
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Employee ID</th>
              <th>Full name</th>
              <th>Role</th>
              <th>Email</th>
              <th>Phone</th>
              <th style="width: 80px;">Actions</th>
            </tr>
          </thead>
          <tbody id="employeeTbody">
            {% for e in employees %}
              <tr class="employee-row" data-role="{{ e.position_id|default:'' }}" data-user-id="{{ e.id }}">
                <td>
                  {% with fi=e.first_name|slice:":1" li=e.last_name|slice:":1" %}
                    <div class="header-avatar" style="width: 2rem; height: 2rem;">
                      {% if fi or li %}
                        {{ fi }}{{ li }}
                      {% else %}
                        {{ e.username|slice:":2"|upper }}
                      {% endif %}
                    </div>
                  {% endwith %}
                </td>
                <td class="text-sm">{{ e.employee_id }}</td>
                <td class="font-medium">{{ e.get_full_name|default:e.username }}</td>
                <td>
                  {% if e.position %}
                    <span class="badge badge-default">{{ e.position.name }}</span>
                  {% else %}
                    <span class="text-sm text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-sm">{{ e.email }}</td>
                <td class="text-sm">{{ e.phone|default:"—" }}</td>
                <td class="table-actions-cell">
                  <div class="dropdown dropdown-fixed">
                    <button class="btn btn-ghost btn-icon" type="button" onclick="toggleDropdown(this)" aria-label="Row actions">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                      </svg>
                    </button>
                    <div class="dropdown-menu">
                      <button class="dropdown-item" type="button" onclick="openEditEmployee({{ e.id }})">View/Edit</button>
                      <button class="dropdown-item" type="button" onclick="openResetPassword('{{ e.employee_id }}','{{ e.email }}','{% url 'reset_employee_password' e.id %}')">Reset password</button>
                      <div class="dropdown-divider"></div>
                      <button class="dropdown-item dropdown-item-destructive" type="button" onclick="openDeleteEmployee({{ e.id }}, '{{ e.employee_id }}', '{{ e.email }}')">Delete</button>
                    </div>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7">
                  <div class="empty-state" style="padding: 2rem;">
                    <div class="empty-state-title">No employees yet</div>
                    <div class="empty-state-description">Add your first employee to start assigning shifts.</div>
                    <button class="btn btn-primary" type="button" onclick="openModal('addEmployeeModal')">+ Add employee</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Add Employee Modal -->
  <div class="modal-overlay hidden" id="addEmployeeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Add New Employee</h2>
        <button class="modal-close" onclick="closeModal('addEmployeeModal')" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" x2="6" y1="6" y2="18"/>
            <line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
      </div>
      <form method="post" action="{% url 'manager_employees' %}" id="addEmployeeForm" novalidate>
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="addFullName">Full name *</label>
            <input type="text" class="form-input" id="addFullName" name="full_name" placeholder="Enter full name" required>
            <div class="form-error-message hidden" id="addFullNameError"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="addEmail">Email / Login *</label>
            <input type="email" class="form-input" id="addEmail" name="email" placeholder="Enter email" required>
            <div class="form-error-message hidden" id="addEmailError"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="addPhone">Phone *</label>
            <input type="tel" class="form-input" id="addPhone" name="phone" placeholder="+1 (555) 123-4567" required>
            <div class="form-error-message hidden" id="addPhoneError"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="addRole">Role *</label>
            <select class="form-select" id="addRole" name="position" required>
              <option value="">Select role...</option>
              {% for p in positions %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
            <div class="form-error-message hidden" id="addRoleError"></div>
          </div>

          <p class="text-sm text-muted">
            Security: A temporary password is generated automatically and shown <strong>only once</strong> after creation.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" type="button" onclick="closeModal('addEmployeeModal')">Cancel</button>
          <button class="btn btn-primary" type="submit">Create employee</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Employee Modal -->
  <div class="modal-overlay hidden" id="editEmployeeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">View/Edit Employee</h2>
        <button class="modal-close" onclick="closeModal('editEmployeeModal')" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" x2="6" y1="6" y2="18"/>
            <line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
      </div>
      <form id="editEmployeeForm" class="modal-body" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" id="editUserId" value="">
        <div class="form-group">
          <label class="form-label" for="editFullName">Full name *</label>
          <input type="text" class="form-input" id="editFullName" value="" required>
          <div class="form-error-message hidden" id="editFullNameError"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editEmail">Email / Login *</label>
          <input type="email" class="form-input" id="editEmail" value="" required>
          <div class="form-error-message hidden" id="editEmailError"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editPhone">Phone *</label>
          <input type="tel" class="form-input" id="editPhone" value="" required>
          <div class="form-error-message hidden" id="editPhoneError"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="editRole">Role *</label>
          <select class="form-select" id="editRole" required>
            <option value="">Select role...</option>
            {% for p in positions %}
              <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
          <div class="form-error-message hidden" id="editRoleError"></div>
        </div>

      </form>
      <div class="modal-footer">
        <button class="btn btn-primary" type="button" onclick="saveEmployeeEdits()">Save</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal-overlay hidden" id="resetPasswordModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Reset password</h2>
        <button class="modal-close" onclick="closeModal('resetPasswordModal')" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" x2="6" y1="6" y2="18"/>
            <line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-sm">Are you sure you want to reset the password for:</p>
        <p class="font-medium mt-2" id="resetEmployeeLabel">EMP-001 (alex@example.com)</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" type="button" onclick="cancelResetPassword()">No</button>
        <button class="btn btn-primary" type="button" onclick="confirmResetPassword()">Yes</button>
      </div>
    </div>
  </div>

  <!-- Delete Employee Confirm Modal -->
  <div class="modal-overlay hidden" id="deleteEmployeeModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">Delete employee</h2>
        <button class="modal-close" type="button" onclick="cancelDeleteEmployee()" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" x2="6" y1="6" y2="18"/>
            <line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-sm">Are you sure you want to delete this employee?</p>
        <p class="font-medium mt-2" id="deleteEmployeeLabel">—</p>
        <p class="text-sm text-muted mt-3">This will remove the employee and their assignments.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" type="button" onclick="cancelDeleteEmployee()">No</button>
        <button class="btn btn-destructive" type="button" onclick="confirmDeleteEmployee()">Yes, delete</button>
      </div>
    </div>
  </div>

  <!-- One-time Credentials Modal -->
  {% if creds %}
    <div class="modal-overlay" id="credentialsModal" data-autoshow="1">
      <div class="modal" style="max-width: 560px;">
        <div class="modal-header">
          <h2 class="modal-title">Credentials (shown once)</h2>
          <button class="modal-close" onclick="closeModal('credentialsModal')" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" x2="6" y1="6" y2="18"/>
              <line x1="6" x2="18" y1="6" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="preview-box">
            <div class="text-sm text-muted">Login</div>
            <div class="flex items-center justify-between mt-1">
              <div class="font-medium" id="credLogin">{{ creds.login }}</div>
              <button class="btn btn-ghost btn-sm" type="button" onclick="copyText('credLogin')">Copy</button>
            </div>

            <div class="text-sm text-muted" style="margin-top: 0.75rem;">Temporary password</div>
            <div class="flex items-center justify-between mt-1">
              <div class="font-medium" id="credPassword">{{ creds.temporary_password }}</div>
              <button class="btn btn-ghost btn-sm" type="button" onclick="copyText('credPassword')">Copy</button>
            </div>
          </div>

          <p class="text-sm text-muted mt-3">
            This password is shown only once. Copy and share it securely.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="button" onclick="closeModal('credentialsModal')">Done</button>
        </div>
      </div>
    </div>
  {% endif %}

	  <!-- Manage Roles Modal -->
	  <div class="modal-overlay hidden" id="rolesModal">
	    <div class="modal" style="max-width: 720px;">
      <div class="modal-header">
        <h2 class="modal-title">Manage roles</h2>
        <button class="modal-close" onclick="closeModal('rolesModal')" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" x2="6" y1="6" y2="18"/>
            <line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="card" style="padding: 1rem; margin-top: 1rem;">
          <div class="flex gap-2">
            <input class="form-input" id="newRoleName" placeholder="New role name (e.g., Barista)">
            <button class="btn btn-primary btn-sm" onclick="addRole()">Add role</button>
          </div>
        </div>

        <div class="table-container" style="margin-top: 1rem;">
          <table class="table" aria-label="Role list">
            <thead>
              <tr>
                <th>Role</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
	            <tbody id="roleTbody">
		              {% for p in positions %}
		                <tr data-position-id="{{ p.id }}">
		                  <td class="role-name">{{ p.name }}</td>
		                  <td class="role-actions-cell">
		                    <button class="btn btn-outline btn-sm" type="button" onclick="renameRole(this)">Rename</button>
		                    <button class="btn btn-ghost btn-icon" type="button" onclick="deleteRole(this)" aria-label="Delete role" title="Delete" style="color: var(--destructive);">
		                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
		                        <path d="M3 6h18"/>
		                        <path d="M8 6V4h8v2"/>
		                        <path d="M19 6l-1 14H6L5 6"/>
		                        <path d="M10 11v6"/>
		                        <path d="M14 11v6"/>
		                      </svg>
		                    </button>
		                  </td>
		                </tr>
		              {% empty %}
		                <tr><td colspan="2" class="text-sm text-muted">No roles yet.</td></tr>
		              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('rolesModal')">Done</button>
      </div>
	    </div>
	  </div>

	  <!-- Delete Role Confirm Modal -->
	  <div class="modal-overlay hidden" id="deleteRoleModal">
	    <div class="modal" style="max-width: 520px;">
	      <div class="modal-header">
	        <h2 class="modal-title">Delete role</h2>
	        <button class="modal-close" type="button" onclick="cancelDeleteRole()" aria-label="Close">
	          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	            <line x1="18" x2="6" y1="6" y2="18"/>
	            <line x1="6" x2="18" y1="6" y2="18"/>
	          </svg>
	        </button>
	      </div>
	      <div class="modal-body">
	        <p class="text-sm">Are you really want to delete this role: <strong id="deleteRoleName">—</strong> ?</p>
	      </div>
	      <div class="modal-footer">
	        <button class="btn btn-outline" type="button" onclick="cancelDeleteRole()">No</button>
	        <button class="btn btn-destructive" type="button" onclick="confirmDeleteRole()">Yes, delete</button>
	      </div>
	    </div>
	  </div>

	  <div
	    id="managerEmployeesPage"
	    data-position-create-url="{% url 'position_create' %}"
	    data-position-update-url-template="{% url 'position_update' 0 %}"
    data-position-delete-url-template="{% url 'position_delete' 0 %}"
    data-employee-details-url-template="{% url 'employee_details' 0 %}"
    data-employee-update-url-template="{% url 'employee_update' 0 %}"
    data-employee-reset-password-url-template="{% url 'reset_employee_password' 0 %}"
    data-employee-delete-url-template="{% url 'employee_delete' 0 %}"
  ></div>
  <form id="resetPasswordForm" method="post">
    {% csrf_token %}
  </form>
  <form id="deleteEmployeeForm" method="post">
    {% csrf_token %}
  </form>
  <script src="{% static 'js/app.js' %}?v={% now 'U' %}"></script>
  <script src="{% static 'js/manager-employees.js' %}?v={% now 'U' %}"></script>
</body>
</html>
